name: Openwrt-x86-64-App  

on:   
  schedule:  
    - cron: "5 0 * * *"  
  workflow_dispatch:  

jobs:  
  matrix:  
    runs-on: ubuntu-latest  
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id   
    outputs:  
      matrix: ${{ steps.set-matrix.outputs.matrix }}  
    steps:  
      - name: 检出代码  
        uses: actions/checkout@v4  

      - name: 构建矩阵  
        id: set-matrix  
        run: |  
          git clone -b lede --single-branch https://github.com/somemoo/OpenWrt-packages.git  
          cd OpenWrt-packages  
          targets=$(find . -maxdepth 1 -name 'luci-app-*' -type d -printf '%f\n' | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "matrix=${targets}" >> $GITHUB_OUTPUT
          cd ..  
          rm -rf OpenWrt-packages  

  build:  
    name: 构建 ${{ matrix.target }}  
    runs-on: ubuntu-latest  
    needs: matrix  
    strategy:  
      matrix: 
        target: ${{ fromJson(needs.matrix.outputs.matrix) }}
      fail-fast: false  

    steps:  
    - name: 检出代码  
      uses: actions/checkout@v4  

    - name: 加载环境  
      env:  
        DEBIAN_FRONTEND: noninteractive  
      run: |  
        sudo apt-get update -qq  
        sudo apt-get install -qq --no-install-recommends \
          build-essential clang llvm flex g++ gawk gcc-multilib gettext \
          git libncurses5-dev libssl-dev python3 python3-pyelftools python3-setuptools \
          rsync unzip zlib1g-dev jq subversion qemu-utils ccache \
          libelf-dev device-tree-compiler libgmp3-dev libmpc-dev  
        sudo apt-get autoremove --purge -qq  
        sudo rm -rf /var/lib/apt/lists/*  

    - name: 设置变量  
      id: ENV  
      run: echo "date=$(date +'%m.%d')" >> $GITHUB_ENV  

    - name: 准备SDK  
      run: |  
        sdk_url="https://downloads.immortalwrt.org/releases/23.05-SNAPSHOT/targets/x86/64/immortalwrt-sdk-23.05-SNAPSHOT-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"  
        wget -q "$sdk_url"  
        mkdir OpenWrt  
        tar -xf immortalwrt-*.tar.xz -C OpenWrt --strip-components=1  
        rm -f immortalwrt-*.tar.xz  

    - name: 编译 po2lmo  
      run: |  
        cd OpenWrt  
        git clone -q https://github.com/openwrt-dev/po2lmo.git  
        (cd po2lmo && make -j$(nproc) && sudo make install)  
        rm -rf po2lmo  

    - name: 准备软件  
      run: |  
        cp -rf App/. OpenWrt/  
        cd OpenWrt  
        rm -rf feeds/luci/applications/luci-app-*  
        git clone -b lede --depth 1 https://github.com/somemoo/OpenWrt-packages packages  
        mv -n packages/* package/  
        rm -rf packages   
        ./scripts/feeds update -a  
        ./scripts/feeds install ${{ matrix.target }}  
        echo "CONFIG_PACKAGE_${{ matrix.target }}=y" >> .config  
        make defconfig  

    - name: 下载依赖  
      run: make -j$(nproc) download  

    - name: 编译 IPK  
      run: make package/${{ matrix.target }}/compile -j$(nproc) V=s  

    - name: 收集 IPK  
      run: |  
        mkdir -p artifact  
        find ./bin/packages -name '*.ipk' -exec cp {} artifact/ \;  

    - name: 上传 IPK  
      uses: actions/upload-artifact@v4  
      with:  
        name: ${{ env.date }}_${{ matrix.target }}  
        path: OpenWrt/artifact/*.ipk  
