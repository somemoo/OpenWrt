#=================================================  
# https://github.com/somemoo/OpenWrt  
# æè¿°: ä½¿ç”¨ GitHub Actions æ„å»º OpenWrt  
# è®¸å¯è¯: MIT  
# ä½œè€…: vison.v   
#=================================================  

name: Openwrt-Firmware-Build

on:
  workflow_dispatch:
    inputs:
      REPO:
        description: 'é€‰æ‹©ä»“åº“'
        default: 'lede'
        type: choice
        options: ['lede', 'immortalwrt', 'openwrt']
      ARCH:
        description: 'è¾“å…¥æ¶æ„ (ä¾‹å¦‚: x86-64,ac58u)'
        default: ''
        type: string
        
  schedule:
    - cron: "5 19 * * *"
  watch:
    types: started

permissions: write-all

jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@main

      - name: æ„å»ºçŸ©é˜µ
        id: set-matrix
        run: |
          FIRMWARE_ARRAY=()
          ARCH_INPUT="${{ github.event.inputs.ARCH }}"
          REPO_SELECTED="${{ github.event.inputs.REPO }}"
          DEFAULT_REPO="lede"
          REPO_USED="${REPO_SELECTED:-$DEFAULT_REPO}"
          HAS_ARCH_INPUT=false

          if [[ -n "$ARCH_INPUT" ]]; then
            HAS_ARCH_INPUT=true
            IFS=',; ' read -ra input_parts <<< "$ARCH_INPUT"
            for part in "${input_parts[@]}"; do
              clean_part=$(echo "$part" | xargs)
              [[ -z "$clean_part" ]] && continue              
              if [[ "$clean_part" =~ ^(lede|immortalwrt|openwrt) ]]; then
                new_target="$clean_part"
              else
                new_target="${REPO_USED}-${clean_part}"
              fi
              FIRMWARE_ARRAY+=("$new_target")
            done
          fi

          if [[ "$HAS_ARCH_INPUT" == false ]] && [[ -f "Build-OpenWrt" && -s "Build-OpenWrt" ]]; then
            while IFS= read -r line; do
              [[ "$line" =~ ^[[:space:]]*# || -z "${line// }" ]] && continue
              IFS=',; ' read -ra parts <<< "$line"
              for part in "${parts[@]}"; do
                clean_part=$(echo "$part" | xargs)
                [[ -z "$clean_part" ]] && continue                
                if [[ "$clean_part" =~ ^(lede|immortalwrt|openwrt) ]]; then
                  new_target="$clean_part"
                else
                  new_target="${REPO_USED}-${clean_part}"
                fi
                FIRMWARE_ARRAY+=("$new_target")
              done
            done < Build-OpenWrt
          fi

          if [[ ${#FIRMWARE_ARRAY[@]} -eq 0 ]]; then
            echo "::error::é”™è¯¯ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„æ„å»ºç›®æ ‡"
            exit 1
          fi

          FIRMWARE_ARRAY=($(printf "%s\n" "${FIRMWARE_ARRAY[@]}" | sort -u))
          targets_json=$(jq -c -n --argjson arr "$(printf '%s\n' "${FIRMWARE_ARRAY[@]}" | jq -R . | jq -s .)" '$arr')
          echo "matrix=$targets_json" >> $GITHUB_OUTPUT

  build:
    name: æ„å»º ${{ matrix.target }}
    runs-on: ubuntu-latest
    needs: matrix
    strategy:
      matrix:
        target: ${{ fromJson(needs.matrix.outputs.matrix) }}
      fail-fast: false
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: é…ç½®å˜é‡
        run: |
          echo "REPO_NAME=$(basename "${{ matrix.target }}" | awk -F'-' '{print $1}')" >> $GITHUB_ENV
          echo "ARCH_NAME=$(basename "${{ matrix.target }}" | sed -E 's/^[^-]*-//')" >> $GITHUB_ENV
          echo "date=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV

      - name: åŠ è½½é…ç½®
        run: |
          source "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/common/settings.ini"
          if [ -f "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/settings.ini" ]; then
            source "${GITHUB_WORKSPACE}/${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/settings.ini"
          fi
          echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
          echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
          echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV
          echo "CUSTOM_SH=${CUSTOM_SH}" >> $GITHUB_ENV
          echo "COMMON_SH=${COMMON_SH}" >> $GITHUB_ENV
          echo "UPLOAD_FIRMWARE_FOR_ARTIFACT=${UPLOAD_FIRMWARE_FOR_ARTIFACT}" >> $GITHUB_ENV
          echo "UPLOAD_EFI_FIRMWARE_FOR_ARTIFACT=${UPLOAD_EFI_FIRMWARE_FOR_ARTIFACT}" >> $GITHUB_ENV
          echo "UPLOAD_FIRMWARE_FOR_RELEASE=${UPLOAD_FIRMWARE_FOR_RELEASE}" >> $GITHUB_ENV

      - name: åŠ è½½ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"
          sudo apt update
          sudo apt full-upgrade -y
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
            libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
            libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf npm python3 \
            python3-pyelftools python3-setuptools qemu-utils rename rsync scons squashfs-tools subversion swig texinfo \
            uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo apt -y autoremove --purge
          sudo apt -y clean
          git clone --depth=1 https://github.com/openwrt-dev/po2lmo
          (cd po2lmo && sudo make && sudo make install)
          df -h

      - name: å…‹éš†ä»£ç 
        run: |
          sudo mkdir -p /mnt/build_wrt
          sudo chown $USER:$USER /mnt/build_wrt
          sudo ln -s /mnt/build_wrt $GITHUB_WORKSPACE/OpenWrt
          
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH OpenWrt
          rsync -a ${{ env.REPO_NAME }}/{common,${{ env.ARCH_NAME }}}/files/ OpenWrt/ 2>/dev/null || :
          cp -rf ${{ env.REPO_NAME }} OpenWrt/
          cd OpenWrt && echo "WRT_HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV

      - name: é…ç½®ç¼“å­˜
        id: ccache
        uses: actions/cache@main
        with:
          key: ${{ env.REPO_NAME }}-${{ env.ARCH_NAME }}-${{env.WRT_HASH}}
          restore-keys: ${{ env.REPO_NAME }}-${{ env.ARCH_NAME }}
          path: |
            ./OpenWrt/.ccache
            ./OpenWrt/staging_dir/host*
            ./OpenWrt/staging_dir/tool*

      - name: æ›´æ–°ç¼“å­˜
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          if [ -d "./OpenWrt/staging_dir" ]; then
            find "./OpenWrt/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r DIR; do
              find "$DIR" -type f -exec touch {} +
            done
            mkdir -p ./OpenWrt/tmp && echo "1" > ./OpenWrt/tmp/.build
            echo "è·³è¿‡toolchainï¼"
          else
            echo "ç¼“å­˜ä¸¢å¤±ï¼"
          fi

          if ${{steps.ccache.outputs.cache-hit != 'true'}}; then
            CACHE_LIST=$(gh cache list --key "${{ env.REPO_NAME }}-${{ env.ARCH_NAME }}-${{env.WRT_HASH}}" | cut -f 1)
            for CACHE_KEY in $CACHE_LIST; do
              gh cache delete $CACHE_KEY
            done
            echo "ç¼“å­˜æ¸…ç†å®Œæˆï¼"
          fi

      - name: æ›´æ–°feeds
        run: |
          cd OpenWrt
          sed -i "/src-git vi /d; \$a src-git vi https://github.com/somemoo/OpenWrt-packages;${{ env.REPO_NAME }}" feeds.conf.default
          ./scripts/feeds update -a
          chmod +x ${{ env.REPO_NAME }}/common/feeds-vi.sh
          sudo "${{ env.REPO_NAME }}/common/feeds-vi.sh"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åº”ç”¨é…ç½®
        run: |
          cd OpenWrt
          if [ -f "${{ env.REPO_NAME }}/common/$COMMON_SH" ]; then
            chmod +x ${{ env.REPO_NAME }}/common/$COMMON_SH
            /bin/bash "${{ env.REPO_NAME }}/common/$COMMON_SH"
          fi
          if [ -f "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH" ]; then
            chmod +x ${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH
            /bin/bash "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CUSTOM_SH"
          fi
          mv ${{ env.REPO_NAME }}/common/$CONFIG_FILE .config
          if [ -f "${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CONFIG_FILE" ]; then
            echo >> .config
            cat ${{ env.REPO_NAME }}/${{ env.ARCH_NAME }}/$CONFIG_FILE >> .config
          fi

      - name: åº”ç”¨è¡¥ä¸
        run: |
          cd OpenWrt
          find "${{ env.REPO_NAME }}/{common,${{ env.ARCH_NAME }}}/patches" -name "*.patch" 2>/dev/null | xargs -I % sh -c 'echo "åº”ç”¨è¡¥ä¸: %" && patch -p1 --no-backup-if-mismatch < % || exit 255'

      - name: ä¸‹è½½ä¾èµ–
        run: |
          cd OpenWrt
          make defconfig -j$(nproc) && make clean -j$(nproc)
          make download -j$(nproc)
          df -hT | grep -v 'tmpfs\|boot'

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        continue-on-error: true
        run: |
          set -eo pipefail
          cd OpenWrt
          ERROR_LOG="${{ matrix.target }}_make_error.log"
          FULL_LOG="${{ matrix.target }}_full.log"

          echo "::group::ğŸŒ€ å¤šçº¿ç¨‹ç¼–è¯‘ ${{ matrix.target }}"
          echo "çº¿ç¨‹æ•°: $(($(nproc)+1))"
          if { make -j$(($(nproc)+1)) V=s 2>&1 | tee "$FULL_LOG"; } | grep -E -A 1 'error:|ERROR:|Error 1|cannot|Cannot|Collected errors:|check_data_file_clashes|^\* ' > "$ERROR_LOG"; then
            echo "âœ… å¤šçº¿ç¨‹ç¼–è¯‘æˆåŠŸï¼"
            rm -f "$FULL_LOG" "$ERROR_LOG" 2>/dev/null
            echo "::endgroup::"
          else
            echo "âŒ å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼"
            echo "::endgroup::"
            echo "::group::ğŸ“œ é”™è¯¯æ‘˜è¦"
            echo "ä»¥ä¸‹æ˜¯æœ€å20è¡Œé”™è¯¯æ—¥å¿—ï¼ˆå®Œæ•´æ—¥å¿—è§Artifactsï¼‰ï¼š"
            tail -n 20 "$ERROR_LOG" | sed 's/^/   /'
            echo "::endgroup::"
            echo "::warning::âš ï¸ å°è¯•å•çº¿ç¨‹ç¼–è¯‘..."

            echo "::group::ğŸŒ å•çº¿ç¨‹ç¼–è¯‘ ${{ matrix.target }}"
            if { make -j1 V=s 2>&1 | tee "$FULL_LOG"; } | grep -E -A 1 'error:|ERROR:|Error 1|cannot|Cannot|Collected errors:|check_data_file_clashes|^\* ' > "$ERROR_LOG"; then
              echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸï¼"
              rm -f "$FULL_LOG" "$ERROR_LOG" 2>/dev/null
              echo "::notice::é™çº§ç¼–è¯‘æˆåŠŸï¼"
              echo "::endgroup::"
            else
              echo "âŒ å•çº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼"
              echo "::endgroup::"
              echo "::group::ğŸ“œ é”™è¯¯æ‘˜è¦"
              echo "ä»¥ä¸‹æ˜¯æœ€å20è¡Œé”™è¯¯æ—¥å¿—ï¼š"
              tail -n 20 "$ERROR_LOG" | sed 's/^/   /'
              echo "::endgroup::"
              echo "::error::âŒ å½»åº•ç¼–è¯‘å¤±è´¥ï¼è¯·æ£€æŸ¥å®Œæ•´æ—¥å¿—"
            fi
          fi

          if [ ! -e "$FULL_LOG" ]; then
            echo "::group::ğŸ’¾ ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ"
            df -hT | grep -v 'tmpfs\|boot'
            echo "::endgroup::"
            echo "::group::ğŸ“¦ ç”Ÿæˆå›ºä»¶åˆ—è¡¨"
            ls -h bin/targets/*/* || true
            echo "::endgroup::"
          else
            echo "LOG=true" >> $GITHUB_ENV  # æ ‡è®°æ—¥å¿—å­˜åœ¨
          fi

      - name: ç»„ç»‡æ–‡ä»¶
        continue-on-error: true
        id: organize
        run: |
          mkdir -p firmware
          if [ "$LOG" = "true" ]; then
            find OpenWrt/ -maxdepth 1 \( -type f -name "*_full.log" -o -name "*_error.log" \) -exec cp -f {} ./firmware/ \; 2>/dev/null || true
            ls firmware
          else
            find OpenWrt/bin/targets/ -path "*/packages/*" -o -path "*/packages" -prune -o -type f ! -name "*buildinfo" ! -name "*json" ! -name "*txt" ! -name "*manifest" -exec cp -f {} ./firmware/ \; 2>/dev/null  
            cp OpenWrt/.config  ./firmware/${{matrix.target}}.config  
            cp OpenWrt/${{ env.REPO_NAME }}/release ./firmware    
            cd firmware  
            [ "$REPO_NAME" = "lede" ] && rename "s/openwrt/$REPO_NAME/" openwrt-*
            for file in *; do tar -czf "$file.tar.gz" "$file" && [ -f "$file" ] && rm -f "$file"; done
            tar -xzf sha256sums.tar.gz && tar -xzf release.tar.gz && tar -xzf ${{matrix.target}}.config.tar.gz && rm -f {sha256sums.tar.gz,release.tar.gz,${{matrix.target}}.config.tar.gz}  
            sed -i '/## å›ºä»¶è¯´æ˜/a 1. å›ºä»¶é‡‡ç”¨çš„åˆ†æ”¯ä¸º${{ env.REPO_NAME }}-${{ env.REPO_BRANCH }}!' release
            mv sha256sums ${{ matrix.target }}_sha256sums
            echo "FIRMWARE_STATUS=true" >> $GITHUB_ENV
            compgen -G "*efi*" > /dev/null && echo "EFI=true" >> $GITHUB_ENV
            compgen -G "*generic*" > /dev/null && echo "COMBINED=true" >> $GITHUB_ENV
            ls
          fi
          cd .. && cd OpenWrt && make clean -j$(nproc)

      - name: å‘å¸ƒå›ºä»¶
        uses: softprops/action-gh-release@master
        id: uprelease
        continue-on-error: true
        if: ${{ env.REPO_TOKEN && env.UPLOAD_FIRMWARE_FOR_RELEASE == 'true' && env.FIRMWARE_STATUS == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        with:
          files: firmware/*
          name: ${{ env.date }}-${{ matrix.target }}
          tag_name: ${{ env.date }}-${{ matrix.target }}
          body_path: firmware/release

      - name: ä¸Šä¼ é€šç”¨å›ºä»¶
        uses: actions/upload-artifact@v4
        continue-on-error: true
        if: ${{ env.UPLOAD_FIRMWARE_FOR_ARTIFACT == 'true' && env.COMBINED == 'true' }} || ${{ env.LOG == 'true' }}
        with:
          name: ${{ env.LOG == 'true' && format('{0}_full_error', matrix.target) || format('{0}-{1}', env.date, matrix.target) }}
          path: |
            firmware/*generic*
            firmware/*_full.log
            !firmware/*ext4*
            !firmware/*efi*
            !firmware/*kernel*
            !firmware/*rootfs*

      - name: ä¸Šä¼ EFIå›ºä»¶
        uses: actions/upload-artifact@v4
        continue-on-error: true
        if: ${{ env.UPLOAD_EFI_FIRMWARE_FOR_ARTIFACT == 'true' && env.EFI == 'true' }} || ${{ env.UPLOAD_FIRMWARE_FOR_ARTIFACT == 'false' && env.LOG == 'true' }}
        with:
          name: ${{ env.LOG == 'true' && format('{0}_full_error', matrix.target) || format('{0}-{1}_EFI', env.date, matrix.target) }}
          path: |
            firmware/*efi*
            firmware/*_full.log
            !firmware/*ext4*

      - name: æ¶ˆæ¯é€šçŸ¥
        if: always()
        run: |
          if [ "${{ env.LOG }}" = "true" ]; then
            LOG_FILE="firmware/${{ matrix.target }}_make_error.log"
            if [ -f "$LOG_FILE" ]; then
              WERROR_LOG=$(tail -n 10 "$LOG_FILE" | sed 's/"/\\\"/g; s/\*/\>/g; s/$/\<br><br>/')
              TERROR_LOG=$(tail -n 10 "$LOG_FILE" | sed 's/$/\\n/')
            else
              ERROR_LOG="æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
            fi
            MSG_TITLE="âŒ å›ºä»¶ ${{ matrix.target }} ç¼–è¯‘å¤±è´¥"  
            WMSG_CONTENT="å¤±è´¥ä¿¡æ¯æ‘˜è¦ï¼š\nğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}\n<details><summary>é”™è¯¯æ—¥å¿—ï¼šç‚¹å‡»å±•å¼€</summary><pre>${WERROR_LOG}</pre></details>\nğŸ“æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"
            TMSG_CONTENT="\n------\nğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}\nğŸ“œé”™è¯¯æ—¥å¿—ï¼š\n<pre>${TERROR_LOG}</pre>\nğŸ“æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"
          else  
            MSG_TITLE="âœ… å›ºä»¶ ${{ matrix.target }} ç¼–è¯‘å®Œæˆ"  
            RELEASE_URL="${{ steps.uprelease.outputs.url }}"
            WMSG_CONTENT="æ„å»ºä¿¡æ¯æ‘˜è¦ï¼š\nğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}\nğŸ¯ç”Ÿæˆç›®æ ‡ï¼š${{ matrix.target }}\nâ¬‡ï¸ä¸‹è½½åœ°å€ï¼š<a href=\\\"${RELEASE_URL}\\\">${{ matrix.target }}-${{ env.REPO_BRANCH }}</a>"
            TMSG_CONTENT="\n------\nğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}\nğŸ¯ç”Ÿæˆç›®æ ‡ï¼š${{ matrix.target }}\nâ¬‡ï¸ä¸‹è½½åœ°å€ï¼š<a href=\"${RELEASE_URL}\">${{ matrix.target }}-${{ env.REPO_BRANCH }}</a>"
          fi  
          
          # PushPlusé€šçŸ¥
          if [ -n "${{ secrets.PUSHPLUS_TOKEN }}" ]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{ \
                \"token\": \"${{ secrets.PUSHPLUS_TOKEN }}\", \
                \"title\": \"$MSG_TITLE\", \
                \"content\": \"$(echo -e $WMSG_CONTENT)\" \
              }" \
              http://www.pushplus.plus/send  
          fi

          # Telegramé€šçŸ¥
          if [ -n "${{ secrets.TELEGRAM_TOKEN }}" ]; then
            TMSG_HTML=$(echo -e "$TMSG_CONTENT" | sed 's/\\n/%0A/g')
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              --data-urlencode "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              --data-urlencode "parse_mode=HTML" \
              --data-urlencode "text=<b>${MSG_TITLE}</b>${TMSG_HTML}"
          fi

      - name: æ¸…ç†ç©ºé—´
        uses: ophub/delete-releases-workflows@main
        with:
          gh_token: ${{secrets.REPO_TOKEN}}
          workflows_keep_day: 1     # ä¿ç•™1å¤©çš„å·¥ä½œæµè®°å½•
          releases_keep_latest: 6   # ä¿ç•™6ä¸ªæœ€æ–°Release
          delete_releases: true     # åˆ é™¤æ—§Release
          delete_tags: true         # åˆ é™¤å…³è”æ ‡ç­¾
          delete_workflows: true    # åˆ é™¤æ—§å·¥ä½œæµ
