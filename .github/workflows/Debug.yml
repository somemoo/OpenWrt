name: Debug  

on:   
  workflow_dispatch:  
  # schedule:  
  #   - cron: "5 23 1/2 * *"  

permissions:  
  contents: read  

env:  
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}  
  SCKEY: ${{ secrets.SCKEY }}  
  PAT: ${{ secrets.PAT }}  
  PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}  
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  
  TZ: Asia/Shanghai  
  date: ${{ github.run_date }}  

jobs:  
  build_openwrt:  
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id  
    runs-on: ubuntu-latest  
    
    name: Debug测试   
    strategy:  
      fail-fast: false  
    
    steps:  
      - name: 检出代码  
        uses: actions/checkout@v2  # 使用稳定的版本  
        with:  
          fetch-depth: 0  

      - name: 定义环境  
        if: always()  
        run: echo "LOG=true" >> $GITHUB_ENV  

      - name: 消息通知  
        if: always()  
        run: |  
          if [ "$LOG" = "true" ]; then  
            MSG_TITLE="❌ 固件 OpenWrt 编译失败"  
            WMSG_CONTENT="失败信息摘要：  
            📅编译日期：${{ env.date }}  
            <details><summary>错误日志</summary>日志</details>  
            📝查看完整日志请下载Artifacts"  
            TMSG_CONTENT="------------------------  
            📅编译日期：${{ env.date }}  
            📝错误日志：  
            <pre>${ERROR_LOG}</pre>  
            📝查看完整日志请下载Artifacts" 
          else  
            MSG_TITLE="✅ 固件 OpenWrt 编译完成"  
            WMSG_CONTENT="构建信息摘要：  
            📅编译日期：${{ env.date }}  
            🔧生成目标：OpenWrt  
            📥下载地址：<a href='https://github.com/somemoo/OpenWrt/releases/download/${{ env.date }}-OpenWrt/OpenWrt-generic-squashfs-combined.img.tar.gz'>OpenWrt-generic-squashfs-combined.img.tar.gz</a>" 
            TMSG_CONTENT="------------------------  
            📅编译日期：${{ env.date }}  
            🔧生成目标：OpenWrt  
            📥下载地址：<a href='https://github.com/somemoo/OpenWrt/releases/download/${{ env.date }}-OpenWrt/OpenWrt-generic-squashfs-combined.img.tar.gz'>OpenWrt-generic-squashfs-combined.img.tar.gz</a>" 
          fi  
          # PushPlus 通知  
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{  
              \"token\": \"${{ secrets.PUSHPLUS_TOKEN }}\",  
              \"title\": \"$MSG_TITLE\",  
              \"content\": \"$WMSG_CONTENT\"  
            }" \
            http://www.pushplus.plus/send  
          
          # Telegram 通知  
          curl -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="true" \
            -d text="<b>$MSG_TITLE</b>%0A$TMSG_CONTENT"
