#=================================================  
on:   
  workflow_dispatch:  
  # schedule:  
  #   - cron: "5 23 1/2 * *"  

permissions:  
  contents: read  

env:  
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}  
  SCKEY: ${{ secrets.SCKEY }}  
  PAT: ${{ secrets.PAT }}  
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  
  TZ: Asia/Shanghai  

jobs:  
  build_openwrt:  
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id  
    runs-on: ubuntu-latest  
    
    name: Debugæµ‹è¯•   
    strategy:  
      fail-fast: false  
        
    steps:  
      - name: æ£€å‡ºä»£ç   
        uses: actions/checkout@v2  # Updated to a stable version  
        with:  
          fetch-depth: 0  

      # - name: SSH connection to Actions  
      #   uses: kiddin9/debugger-action@master  

      - name: å®šä¹‰ç¯å¢ƒ  
        if: always()  
        run: echo "LOG=true" >> $GITHUB_ENV  

      - name: æ¶ˆæ¯é€šçŸ¥  
        if: always()  
        run: |  
          # é€šç”¨æ¶ˆæ¯æ¨¡æ¿æ„å»º  
          if [ "$LOG" = "true" ]; then  
            ERROR_LOG=$(cat firmware/${{ matrix.target }}_make_error.log | sed 's/</\&lt;/g; s/>/\&gt;/g')  
            # å¾®ä¿¡é€šçŸ¥ä½¿ç”¨Markdownæ ¼å¼æ¢è¡Œç¬¦  
            WECHAT_MSG="âš ï¸ ç¼–è¯‘å¤±è´¥ï¼\n\nğŸ”§ ç›®æ ‡ï¼š${{ matrix.target }}\n\né”™è¯¯æ—¥å¿—ï¼š\n${ERROR_LOG}\n\næŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"  
            # Telegramä½¿ç”¨HTMLæ ‡ç­¾æ¢è¡Œ  
            TG_MSG="<b>âš ï¸ ç¼–è¯‘å¤±è´¥ï¼</b>\n\nğŸ”§ ç›®æ ‡ï¼š${{ matrix.target }}\n\n<pre>é”™è¯¯æ—¥å¿—ï¼š\n${ERROR_LOG}</pre>\n\næŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"  
            TITLE="âŒ å›ºä»¶ ${{ env.date }}-${{ matrix.target }} ç¼–è¯‘å¤±è´¥"  
          else  
            # å¾®ä¿¡é€šçŸ¥ä½¿ç”¨Markdownæ ¼å¼æ¢è¡Œç¬¦  
            WECHAT_MSG="ğŸ‰ ç¼–è¯‘æˆåŠŸï¼\n\nğŸ“… æ—¥æœŸï¼š${{ env.date }}\nğŸ”§ ç›®æ ‡ï¼š${{ matrix.target }}\nğŸš€ å·²ä¸Šä¼ åˆ° Release"  
            # Telegramä½¿ç”¨HTMLæ ‡ç­¾æ¢è¡Œ  
            TG_MSG="<b>ğŸ‰ ç¼–è¯‘æˆåŠŸï¼</b>\n\nğŸ“… æ—¥æœŸï¼š${{ env.date }}\nğŸ”§ ç›®æ ‡ï¼š${{ matrix.target }}\nğŸš€ å·²ä¸Šä¼ åˆ° Release"  
            TITLE="âœ… å›ºä»¶ ${{ env.date }}-${{ matrix.target }} ç¼–è¯‘å®Œæˆ"  
          fi  

          # Serveré…±é€šçŸ¥ï¼ˆä½¿ç”¨Markdownæ ¼å¼ï¼‰  
          if [ -n "$SCKEY" ]; then  
            curl -X POST \
              -d "title=${TITLE}" \
              -d "desp=${WECHAT_MSG//\n/%0A}" \  # æ˜¾å¼è½¬æ¢æ¢è¡Œç¬¦ä¸ºURLç¼–ç   
              "https://sctapi.ftqq.com/$SCKEY.send"  
          fi  

          # Telegramé€šçŸ¥ï¼ˆä½¿ç”¨HTMLæ ¼å¼ï¼‰  
          if [ -n "$TELEGRAM_TOKEN" ]; then  
            # æ›¿æ¢æ¢è¡Œç¬¦ä¸ºHTMLæ ‡ç­¾  
            TG_MSG=${TG_MSG//\n/%0A}  
            TG_MSG=${TG_MSG//\n/<br>}  
            curl -s -k \
              --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
              --data-urlencode "text=<b>${TITLE}</b>%0A${TG_MSG}" \
              --data-urlencode "parse_mode=HTML" \
              --data-urlencode "disable_web_page_preview=true" \
              "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage"  
          fi
