name: Debug  

on:   
  workflow_dispatch:  
  # schedule:  
  #   - cron: "5 23 1/2 * *"  

permissions:  
  contents: read  

env:  
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}  
  SCKEY: ${{ secrets.SCKEY }}  
  PAT: ${{ secrets.PAT }}  
  PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}  
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  
  TZ: Asia/Shanghai  
  date: ${{ github.run_date }}  

jobs:  
  build_openwrt:  
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id  
    runs-on: ubuntu-latest  
    
    name: Debugæµ‹è¯•   
    strategy:  
      fail-fast: false  
    
    steps:  
      - name: æ£€å‡ºä»£ç   
        uses: actions/checkout@v2  # ä½¿ç”¨ç¨³å®šçš„ç‰ˆæœ¬  
        with:  
          fetch-depth: 0  

      - name: å®šä¹‰ç¯å¢ƒ  
        if: always()  
        run: echo "LOGd=true" >> $GITHUB_ENV  

      - name: æ¶ˆæ¯é€šçŸ¥
        if: always()
        run: |
          RELEASE_URL="${{ steps.release.outputs.url }}"  # ç¡®ä¿æ­¥éª¤IDä¸åˆ›å»ºReleaseçš„æ­¥éª¤ä¸€è‡´

          if [ "${{ env.LOG }}" = "true" ]; then
            # é”™è¯¯åˆ†æ”¯å¤„ç†
            LOG_FILE="firmware/${{ matrix.target }}_make_error.log"
            if [ -f "$LOG_FILE" ]; then
              ERROR_LOG=$(tail -n 10 "$LOG_FILE" | sed -e 's/"/\\"/g' -e 's/\\/\\\\/g' -e 's/&/&amp;/g' -e 's/</&lt;/g' -e 's/>/&gt;/g' -e 's/\x1B\[[0-9;]*[a-zA-Z]//g')
            else
              ERROR_LOG="æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
            fi
            MSG_TITLE="âŒ å›ºä»¶ ${{ matrix.target }} ç¼–è¯‘å¤±è´¥"  
            WMSG_CONTENT="å¤±è´¥ä¿¡æ¯æ‘˜è¦ï¼š\\nğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}\\n<details><summary>é”™è¯¯æ—¥å¿—</summary><pre>${ERROR_LOG}</pre></details>\\nğŸ“æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"
            TMSG_CONTENT="------%0AğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}%0AğŸ“é”™è¯¯æ—¥å¿—ï¼š%0A<pre>${ERROR_LOG}</pre>%0AğŸ“æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"
          else  
            # æˆåŠŸåˆ†æ”¯å¤„ç†
            MSG_TITLE="âœ… å›ºä»¶ ${{ matrix.target }} ç¼–è¯‘å®Œæˆ"  
            WMSG_CONTENT="æ„å»ºä¿¡æ¯æ‘˜è¦ï¼š\\nğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}\\nğŸ”§ç”Ÿæˆç›®æ ‡ï¼š${{ matrix.target }}\\nğŸ“¥ä¸‹è½½åœ°å€ï¼š<a href=\\\"${RELEASE_URL}\\\">${{ matrix.target }}-${{ env.REPO_BRANCH }}</a>"
            TMSG_CONTENT="------%0AğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}%0AğŸ”§ç”Ÿæˆç›®æ ‡ï¼š${{ matrix.target }}%0AğŸ“¥ä¸‹è½½åœ°å€ï¼š<a href=\"${RELEASE_URL}\">${{ matrix.target }}-${{ env.REPO_BRANCH }}</a>"
          fi  

          # PushPlus é€šçŸ¥ï¼ˆä¼˜åŒ–JSONæ„å»ºï¼‰
          if [ -n "${{ secrets.PUSHPLUS_TOKEN }}" ]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{
                "token": "'"${{ secrets.PUSHPLUS_TOKEN}}"'",
                "title": "'"$MSG_TITLE"'",
                "content": "'"$(echo -e "$WMSG_CONTENT" | sed 's/"/\\"/g')"'"
              }' \
              http://www.pushplus.plus/send
          fi

          # Telegram é€šçŸ¥ï¼ˆç®€åŒ–å¤„ç†ï¼‰
          if [ -n "${{ secrets.TELEGRAM_TOKEN }}" ]; then
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              --data-urlencode "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              --data-urlencode "parse_mode=HTML" \
              --data-urlencode "text=<b>${MSG_TITLE}</b>${TMSG_CONTENT}"
          fi

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 1
