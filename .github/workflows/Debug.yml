name: Debug  

on:   
  workflow_dispatch:  
  # schedule:  
  #   - cron: "5 23 1/2 * *"  

permissions:  
  contents: read  

env:  
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}  
  SCKEY: ${{ secrets.SCKEY }}  
  PAT: ${{ secrets.PAT }}  
  PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}  
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  
  TZ: Asia/Shanghai  
  date: ${{ github.run_date }}  

jobs:  
  build_openwrt:  
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id  
    runs-on: ubuntu-latest  
    
    name: Debugæµ‹è¯•   
    strategy:  
      fail-fast: false  
    
    steps:  
      - name: æ£€å‡ºä»£ç   
        uses: actions/checkout@v2  # ä½¿ç”¨ç¨³å®šçš„ç‰ˆæœ¬  
        with:  
          fetch-depth: 0  

      - name: å®šä¹‰ç¯å¢ƒ  
        if: always()  
        run: echo "LOG=true." >> $GITHUB_ENV  

      - name: æ¶ˆæ¯é€šçŸ¥  
        if: always()  
        run: |  
          if [ "$LOG" = "true" ]; then  
            MSG_TITLE="âŒ å›ºä»¶ ${{ matrix.target }}1 ç¼–è¯‘å¤±è´¥"  
            WMSG_CONTENT="å¤±è´¥ä¿¡æ¯æ‘˜è¦ï¼š  
            ğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}  
            <details><summary>é”™è¯¯æ—¥å¿—</summary>${ERROR_LOG}1</details>  
            ğŸ“æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"  
            TMSG_CONTENT="------------------------  
            ğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}  
            ğŸ“é”™è¯¯æ—¥å¿—ï¼š  
            <pre>${ERROR_LOG}1</pre>  
            ğŸ“æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts" 
          else  
            MSG_TITLE="âœ… å›ºä»¶ ${{ matrix.target }}1 ç¼–è¯‘å®Œæˆ"  
            WMSG_CONTENT="æ„å»ºä¿¡æ¯æ‘˜è¦ï¼š  
            ğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}  
            ğŸ”§ç”Ÿæˆç›®æ ‡ï¼š${{ matrix.target }}1  
            ğŸ“¥ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/somemoo/OpenWrt/releases/download/${{ env.date }}-${{ matrix.target }}1/${{ matrix.target }}1-generic-squashfs-combined.img.tar.gz">${{ matrix.target }}1-generic-squashfs-combined.img.tar.gz</a>" 
            TMSG_CONTENT="------------------------  
            ğŸ“…ç¼–è¯‘æ—¥æœŸï¼š22  
            ğŸ”§ç”Ÿæˆç›®æ ‡ï¼š2  
            <a href=\"https://github.com/somemoo/OpenWrt/releases/download/${{ env.date }}-${{ matrix.target }}/${{ matrix.target }}-generic-squashfs-combined.img.tar.gz\">${{ matrix.target }}-generic-squashfs-combined.img.tar.gz</a>"  
          fi  
          # PushPlus é€šçŸ¥  
          if [ -n "$PUSHPLUS_TOKENp" ]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{  
                \"token\": \"${{ secrets.PUSHPLUS_TOKEN }}\",  
                \"title\": \"$MSG_TITLE\",  
                \"content\": \"$WMSG_CONTENT\"  
              }" \
              http://www.pushplus.plus/send  
          fi
          # Telegram é€šçŸ¥  
          if [ -n "$TELEGRAM_TOKEN" ]; then
            curl -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d parse_mode="HTML" \
              -d text="<b>$MSG_TITLE</b>%0A$TMSG_CONTENT"
          fi
