#=================================================  
# https://github.com/somemoo/OpenWrt  
# æè¿°: ä½¿ç”¨ GitHub Actions æ„å»º OpenWrt  
# è®¸å¯è¯: MIT  
# ä½œè€…: vison.v   
#=================================================  

name: Debug

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  SCKEY: ${{ secrets.SCKEY }}
  PAT: ${{ secrets.PAT }}
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  build_openwrt:
    if: github.event.repository.owner.id == github.event.sender.id || !github.event.sender.id
    runs-on: ubuntu-latest
    name: Debug
    strategy:
      fail-fast: false

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: é…ç½®å˜é‡
        run: |
          echo "date=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
          echo "LOG=true" >> $GITHUB_ENV

      - name: æ¶ˆæ¯é€šçŸ¥
        if: always()
        run: |
          if [ "${{ env.LOG }}" = "true" ]; then
            LOG_FILE="ConfiguCollected errors:<br>* check_data_file_clashes: Package luci-app-socat wants to install file /home/runner/work/OpenWrt/OpenWrt/OpenWrt/build_dir/target-x86_64_musl/root-x86/etc/config/socat<br> \But that file is already provided by package  * socat<br>æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"
            #ERROR_LOG=$(tail -n 10 "$LOG_FILE" | sed 's/"/\\"/g; s/$/\\n/')
            MSG_TITLE="âŒ å›ºä»¶ ${{ matrix.target }} ç¼–è¯‘å¤±è´¥"  
            WMSG_CONTENT="å¤±è´¥ä¿¡æ¯æ‘˜è¦ï¼š\nğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}\n<details><summary>é”™è¯¯æ—¥å¿—:</summary><pre>${LOG_FILE}</pre></details>\nğŸ“æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"
          else  
            MSG_TITLE="âœ… å›ºä»¶ ${{ matrix.target }} ç¼–è¯‘å®Œæˆ"  
            RELEASE_URL="${{ steps.uprelease.outputs.url }}"
            WMSG_CONTENT="æ„å»ºä¿¡æ¯æ‘˜è¦ï¼š\\nğŸ“…ç¼–è¯‘æ—¥æœŸï¼š${{ env.date }}\\nğŸ”§ç”Ÿæˆç›®æ ‡ï¼š${{ matrix.target }}\\nğŸ“¥ä¸‹è½½åœ°å€ï¼š<a href=\\\"${RELEASE_URL}\\\">${{ matrix.target }}-${{ env.REPO_BRANCH }}</a>"
          fi  
          
          # PushPlus é€šçŸ¥
          if [ -n "${{ secrets.PUSHPLUS_TOKEN }}" ]; then
            echo "$WMSG_CONTENT"
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{ \
                \"token\": \"${{ secrets.PUSHPLUS_TOKEN }}\", \
                \"title\": \"$MSG_TITLE\", \
                \"content\": \"$(echo -e $WMSG_CONTENT)\" \
              }" \
              http://www.pushplus.plus/send  
          fi
