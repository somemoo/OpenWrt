#=================================================  
# https://github.com/P3TERX/Actions-OpenWrt  
# æè¿°: ä½¿ç”¨ GitHub Actions æ„å»º OpenWrt  
# è®¸å¯è¯: MIT  
# ä½œè€…: P3TERX  
# åšå®¢: https://p3terx.com  
#=================================================  

name: Debug  

on:   
  workflow_dispatch:  
  # schedule:  
  #   - cron: "5 23 1/2 * *"  

permissions:  
  contents: read  

env:  
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}  
  SCKEY: ${{ secrets.SCKEY }}  
  PAT: ${{ secrets.PAT }}  
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}  
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  
  TZ: Asia/Shanghai  

jobs:  
  build_openwrt:  
    if: github.event.repository.owner.id == github.event.sender.id || ! github.event.sender.id  
    runs-on: ubuntu-latest  
    
    name: Debugæµ‹è¯•   
    strategy:  
      fail-fast: false  
        
    steps:  
      - name: æ£€å‡ºä»£ç   
        uses: actions/checkout@v2  # Updated to a stable version  
        with:  
          fetch-depth: 0   

      - name: å®šä¹‰ç¯å¢ƒ  
        if: always()  
        run: echo "LOG=true" >> $GITHUB_ENV  

      - name: æ¶ˆæ¯é€šçŸ¥  
        if: always()  
        run: |  
          if [ "$LOG" = "true" ]; then  
            MSG_TITLE="âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"  
            MSG_CONTENT="<b>-----------------------</b>  
            ğŸ“ç›®æ ‡ï¼šæµ‹è¯•  
            <pre>ğŸ“é”™è¯¯æ—¥å¿—ï¼š  
            æ—¥å¿—</pre>  
            ğŸ“æŸ¥çœ‹å®Œæ•´æ—¥å¿—è¯·ä¸‹è½½Artifacts"  
          else  
            MSG_TITLE="âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"  
            MSG_CONTENT="<b>-----------------------</b>    
            ğŸ“… æ—¥æœŸï¼š$(date +'%Y-%m-%d')    
            ğŸ”§ ç›®æ ‡ï¼šæµ‹è¯•    
            ğŸš€ å·²ä¸Šä¼ åˆ° Release"  
          fi  
          
          if [ -n "$SCKEYD" ]; then  
            curl -X POST \
              --data-urlencode "key=${{ secrets.SCKEY }}" \
              --data-urlencode "title=${MSG_TITLE}" \
              --data-urlencode "desp=${MSG_CONTENT}" \
              "https://sctapi.ftqq.com/${{ secrets.SCKEY }}.send"  
          fi  
          
          if [ -n "$TELEGRAM_TOKEN" ]; then  
            curl -s -k \
              --data-urlencode "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              --data-urlencode "text=<b>${MSG_TITLE}</b>  
              ${MSG_CONTENT}" \
              --data-urlencode "parse_mode=HTML" \
              --data-urlencode "disable_web_page_preview=true" \
              "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"  
          fi
